## mysql高可用方案

### mycat+mysql 高可用方案

- mycat 不负责数据同步问题，实现mycat 读写分离，需要 mysql 的主从同步机制
- Mycat的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的SQL语句，首先对SQL语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此SQL发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。

#### 方案：

- 三台服务器：

	- |         | mysql | mycat |
		| ------- | ----- | ----- |
		| server1 | 主库  | Y     |
		| server2 | 从库  |       |
		| server3 | 从库  | Y     |

		server1 服务器上部署主库和 mycat

	- server2 服务器部署从库，负责业务数据读取
	- server3 服务器部署从库，负责统计业务数据读取

- 分表分库操作：

	- 先垂直拆分出表为基本不和其他业务表关联查询的日志表，比如操作日志、记录日志等表
	- 配置表或需要频繁关联查询的表设置为全局表。
	- 其他业务表在水平拆分
		- 限制：同一个数据库中表数据库可以关联查询，但是不能夸库关联查询。
		- 拆分规则为自增方案，选择时间字段为分区字段，根据业务，将同一段时间的数据放在一个库中
		- 设置：一个分片库存储一个季度数据。
		- 初期配置 8 个数据库，可存储两年数据。

- 配置读写分离

	- 主库负责数据插入更新
	- 第一个从库负责日常业务查询
	- 第二个从库负责统计查询，并作为业务查询备用库。

- 主从配置：

	- 主库和第一个从库配置为半同步复制，解决数据读取延迟问题。（主库已经插入数据，再次查询，不显示数据）
	- 第二个从库不做限制。

#### 说明：

- mycat 为数据库中间件，位置处在业务应用和数据库之间，业务只需要和 mycat 做数据交互，不必关注数据具体分配存储的位置。
- mycat 配置文件有三个：

	- server.xml	mycat 虚拟库账号、参数、权限等配置，
	- schema.xml	mycat 对应物理数据库和数据库表连接配置、读写分离配置
	- rule.xml Mycat分片（分库分表）规则
		- 创建分片规则，确定规则名称、选择规则对应的算法、确定物理表中适配此规则的字段
- 分片规则整体有两种：

	- 固定分片数量，再根据各种算法将数据尽量均匀存储到这些分片库中。
	- 分片增长类型，比如
		- 根据主键 id 数据范围约定，每个分片表存储 500w 条数据
		- 根据时间数据范围决定存储到那个分片库，比如每个分片库存储 1 年数据
- 数据切分的原则：
- 第一原则：能不切分尽量不要切分。
	- 第二原则：如果要切分一定要选择合适的切分规则，提前规划好。
- 第三原则：数据切分尽量通过数据冗余或者表分组（Table Group）来降低跨库 Join 的可能。
	- 第四原则：由于数据库中间件对数据 Join 实现的优劣难以把握，而且实现高性能难度极大，业务读取尽量少使用多表 Join。
- 负载均衡
  - 一主多从结构中，可配置，读只从从库读，写只写入主库，也可以配置，读在随机主库和从库之间读取
- 故障转移：
  - 监控主从状态，如果主库挂掉，在双主的模式下，跳转到第二个主库上，如果是一主多从，可以配置直接在从库读写，后续手动将主变为从，从变为主
  - 如果从库挂掉，直接在主库上实现读写
- 产品修改：
  - 1.对外键关联的表，需要加上冗余的分片字段，保证数据插入的时候，关联数据在同一个分片库中，但是正常查询支持外键
  - 2.排序分组字段必须在查询时候带上，因为 mycat 是将各个分片数据查出来后在内存中分组，所以排序分组字段也必须查出来
  - 3.数据更新 sql 不能更新分片字段
  - 支持主键全局自增

